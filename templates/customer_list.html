{% extends "base.html" %}
{% block head %}
    <title>Danh sách khách hàng</title>
    <style>
        :root { 
            --color-primary: #2563eb; 
            --color-accent: #06b6d4; 
            --color-support: #16a34a; 
            --surface: #f8fafc; 
            --surface-soft: #f1f5f9; 
            --border: #e6eef7; 
            --text: #1f2937;
            --group-potential: #f59e0b;    /* Tiềm năng - vàng */
            --group-loyal: #16a34a;        /* Thân thiết - xanh lá */
            --group-vip: #dc2626;          /* Quan trọng - đỏ */
            --group-active: #10b981;       /* Active - xanh lá đậm */
            --group-inactive: #6b7280;     /* Inactive - xám */
        }
        
        .header-title { font-size: 22px; font-weight: 700; color: var(--text); }
        .header-logo { display: flex; align-items: center; gap: 10px; margin-right: 18px; }
        .header-logo .logo-box { width: 36px; height: 36px; border-radius: 8px; background: var(--surface-soft); display: flex; align-items: center; justify-content: center; color: var(--color-primary); }
        
        .header { position: sticky; top: 0; z-index: 50; display: flex; align-items: center; justify-content: space-between; margin-left: -40px; margin-right: -40px; padding: 12px 40px; background: var(--surface); border-bottom: 1px solid var(--border); margin-bottom: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        
        .search-filter-bar { display: flex; gap: 12px; margin-bottom: 20px; align-items: center; }
        .search-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 300px; font-size: 14px; }
        .filter-select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white; }
        .add-customer-btn { padding: 8px 16px; background: var(--color-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .add-customer-btn:hover { background: #1e40af; }
        
        .customers-table { width: 100%; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden; }
        .customers-table th { background: var(--surface-soft); color: var(--color-primary); padding: 12px; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border); }
        .customers-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .customers-table tr:hover { background: #f8fafc; }
        
        .customer-group-badge { 
            padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase;
        }
        .group-potential { background: rgba(245, 158, 11, 0.1); color: var(--group-potential); }
        .group-loyal { background: rgba(22, 163, 74, 0.1); color: var(--group-support); }
        .group-vip { background: rgba(220, 38, 38, 0.1); color: var(--group-vip); }
        .group-active { background: rgba(16, 185, 129, 0.1); color: var(--group-active); }
        .group-inactive { background: rgba(107, 114, 128, 0.1); color: var(--group-inactive); }
        
        .customer-name { font-weight: 600; color: var(--text); }
        .customer-name-link { text-decoration: none; color: inherit; }
        .customer-name-link:hover .customer-name { color: var(--color-primary); text-decoration: underline; }
        .customer-id { font-family: monospace; color: #6b7280; font-size: 13px; }
        .amount { font-weight: 600; color: var(--color-support); }
        .last-purchase { color: #6b7280; font-size: 13px; }
        
        .stats-summary { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex: 1; }
        .stat-number { font-size: 24px; font-weight: 700; color: var(--color-primary); }
        .stat-label { color: #6b7280; font-size: 14px; margin-top: 4px; }
        
        .empty-state { text-align: center; padding: 40px; color: #6b7280; }
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
        
        .action-buttons { display: flex; gap: 8px; margin-bottom: 20px; }
        .action-buttons button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover { background: #1e40af; }
        .btn-success { background: var(--color-support); color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        
        .checkbox-cell { width: 40px; text-align: center; }
        .checkbox-cell input[type="checkbox"] { transform: scale(1.2); }
        
        .selected-info { background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid var(--color-primary); }
        .selected-count { font-weight: 600; color: var(--color-primary); }
    </style>
{% endblock %}

{% block content %}
    <div class="header">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div class="header-logo">
                <div class="logo-box" aria-label="Customers">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="none">
                        <circle cx="9" cy="8" r="3" fill="#2563eb" opacity="0.9"></circle>
                        <circle cx="16" cy="9" r="2.5" fill="#2563eb" opacity="0.6"></circle>
                        <rect x="4" y="13" width="10" height="7" rx="3.5" fill="#2563eb" opacity="0.15"></rect>
                        <rect x="12.5" y="13.5" width="7" height="6.5" rx="3.25" fill="#2563eb" opacity="0.12"></rect>
                    </svg>
                </div>
                <div class="header-title">Danh sách khách hàng</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="color: #6b7280; font-size: 14px;">Tổng: {{ customers|length }} khách hàng</span>
        </div>
    </div>

    <!-- Thống kê tổng quan -->
    <div class="stats-summary">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_customers }}</div>
            <div class="stat-label">Tổng khách hàng</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.active_customers }}</div>
            <div class="stat-label">Đang giao dịch</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.active_orders }}</div>
            <div class="stat-label">Đơn hàng hoạt động</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.active_amount }}</div>
            <div class="stat-label">Doanh thu</div>
        </div>
    </div>

    <!-- Thanh tìm kiếm và lọc -->
    <div class="search-filter-bar">
        <input type="text" class="search-input" placeholder="Tìm kiếm theo tên, mã KH..." id="searchInput">
        <select class="filter-select" id="groupFilter">
            <option value="">Tất cả nhóm</option>
            <option value="potential">Tiềm năng</option>
            <option value="loyal">Thân thiết</option>
            <option value="vip">Quan trọng</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
        </select>
        <button class="add-customer-btn" onclick="addNewCustomer()">+ Thêm khách hàng</button>
        <button class="add-customer-btn" onclick="importData()">Nhập dữ liệu</button>
        <button class="add-customer-btn" onclick="exportAll()">Xuất tất cả</button>
    </div>

    <!-- Thông tin khách hàng đã chọn -->
    <div id="selectedInfo" class="selected-info" style="display: none;">
        <span class="selected-count" id="selectedCount">0</span> khách hàng đã được chọn
        <div class="action-buttons" style="margin-top: 8px;">
            <button class="btn-primary" onclick="editSelected()">Chỉnh sửa</button>
            <button class="btn-warning" onclick="changeGroupSelected()">Đổi nhóm</button>
            <button class="btn-danger" onclick="deleteSelected()">Xóa</button>
            <button class="btn-secondary" onclick="exportSelected()">Xuất dữ liệu</button>
        </div>
    </div>

    <!-- Bảng danh sách khách hàng -->
    {% if customers %}
    <table class="customers-table">
        <thead>
            <tr>
                <th class="checkbox-cell">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                </th>
                <th>Mã KH</th>
                <th>Tên khách hàng</th>
                <th>Nhóm khách hàng</th>
                <th>Trạng thái</th>
                <th>Lần cuối mua hàng</th>
                <th>Tổng tiền đã mua</th>
            </tr>
        </thead>
        <tbody id="customersTableBody">
            {% for customer in customers %}
            <tr data-group="{{ customer.group }}" data-status="{{ customer.status }}" data-name="{{ customer.name|lower }}">
                <td class="checkbox-cell">
                    <input type="checkbox" class="customer-checkbox" value="{{ customer.code }}" onchange="updateSelectedInfo()">
                </td>
                <td><span class="customer-id">{{ customer.code }}</span></td>
                <td>
                    <a href="/customer-dashboard?code={{ customer.code }}" class="customer-name-link">
                        <span class="customer-name">{{ customer.name }}</span>
                    </a>
                </td>
                <td>
                    <span class="customer-group-badge group-{{ customer.group }}">
                        {% if customer.group == 'potential' %}Tiềm năng
                        {% elif customer.group == 'loyal' %}Thân thiết
                        {% elif customer.group == 'vip' %}Quan trọng
                        {% endif %}
                    </span>
                </td>
                <td>
                    <span class="customer-group-badge group-{{ customer.status }}">
                        {% if customer.status == 'active' %}Active
                        {% elif customer.status == 'inactive' %}Inactive
                        {% endif %}
                    </span>
                </td>
                <td><span class="last-purchase">{{ customer.last_purchase or 'Chưa có' }}</span></td>
                <td><span class="amount">{{ customer.total_amount or '0đ' }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <h3>Chưa có dữ liệu khách hàng</h3>
        <p>Hãy thêm khách hàng đầu tiên để bắt đầu quản lý.</p>
    </div>
    {% endif %}

    <script>
        // Tìm kiếm và lọc khách hàng
        document.getElementById('searchInput').addEventListener('input', filterCustomers);
        document.getElementById('groupFilter').addEventListener('change', filterCustomers);

        function filterCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const groupFilter = document.getElementById('groupFilter').value;
            const rows = document.querySelectorAll('#customersTableBody tr');

            rows.forEach(row => {
                const name = row.dataset.name;
                const group = row.dataset.group;
                const status = row.dataset.status;
                
                const matchesSearch = name.includes(searchTerm);
                const matchesGroup = !groupFilter || group === groupFilter || status === groupFilter;
                
                row.style.display = (matchesSearch && matchesGroup) ? '' : 'none';
            });
        }


        function addNewCustomer() {
            alert('Thêm khách hàng mới');
        }

        function updateSelectedInfo() {
            const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
            const count = checkboxes.length;
            const selectedInfo = document.getElementById('selectedInfo');
            const selectedCount = document.getElementById('selectedCount');
            
            selectedCount.textContent = count;
            selectedInfo.style.display = count > 0 ? 'block' : 'none';
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateSelectedInfo();
        }

        function editSelected() {
            const selected = getSelectedCustomers();
            alert(`Chỉnh sửa ${selected.length} khách hàng: ${selected.join(', ')}`);
        }

        function changeGroupSelected() {
            const selected = getSelectedCustomers();
            alert(`Đổi nhóm ${selected.length} khách hàng: ${selected.join(', ')}`);
        }

        function deleteSelected() {
            const selected = getSelectedCustomers();
            if (confirm(`Xóa ${selected.length} khách hàng: ${selected.join(', ')}?`)) {
                alert('Đã xóa khách hàng');
            }
        }

        function exportSelected() {
            const selected = getSelectedCustomers();
            alert(`Xuất dữ liệu ${selected.length} khách hàng: ${selected.join(', ')}`);
        }

        function importData() {
            alert('Nhập dữ liệu từ file Excel');
        }

        function exportAll() {
            alert('Xuất tất cả dữ liệu khách hàng');
        }

        function getSelectedCustomers() {
            const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
    </script>
{% endblock %}
