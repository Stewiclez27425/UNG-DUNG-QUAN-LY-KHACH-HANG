{% extends "base.html" %}
{% block title %}Tổng quan bán hàng{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
    <style>
        /* Skeleton loading */
        .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Fade-in animation */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeInUp 0.6s ease-out forwards; }
        .stagger-1 { animation-delay: 0.1s; opacity: 0; }
        .stagger-2 { animation-delay: 0.2s; opacity: 0; }
        .stagger-3 { animation-delay: 0.3s; opacity: 0; }

        /* Topbar */
        .topbar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .title { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .select, .button { background: var(--panel); color: var(--text); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 10px 12px; font: inherit; }
        .button.brand { background: linear-gradient(135deg, var(--brand), var(--brand-2)); border: 0; }
        .button.ghost { background: transparent; border: 1px dashed rgba(255,255,255,0.16); color: var(--muted); }

        /* KPI cards */
        .grid { display: grid; gap: 14px; }
        .grid.kpi { grid-template-columns: repeat(6, 1fr); }
        .card { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.25); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card:hover { transform: translateY(-4px); box-shadow: 0 12px 28px rgba(0,0,0,0.35), 0 0 0 1px rgba(99,102,241,0.15); border-color: rgba(99,102,241,0.2); }
        .kpi .card { display: grid; gap: 8px; cursor: pointer; }
        .kpi .label { color: var(--muted); font-size: 12px; }
        .kpi .value { font-size: 22px; font-weight: 700; letter-spacing: .2px; }
        .kpi .trend { font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .trend.up { color: var(--ok); }
        .trend.down { color: var(--bad); }

        /* Charts */
        .grid.charts { grid-template-columns: 2fr 1fr 1fr; }
        .chart-wrap { padding: 10px; }
        canvas { width: 100%; height: 240px; }

        /* Tables & alerts */
        .section-title { font-size: 14px; color: var(--muted); margin: 8px 2px 6px; text-transform: uppercase; letter-spacing: .08em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align: left; font-size: 14px; }
        th { color: var(--muted); font-weight: 600; }
        .tags { display: inline-flex; gap: 6px; flex-wrap: wrap; }
        .tag { font-size: 12px; padding: 4px 8px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.08); color: var(--muted); }
        .tag.warn { color: #f59e0b; border-color: rgba(245,158,11,.35); }
        .tag.bad { color: #ef4444; border-color: rgba(239,68,68,.35); }
        .quick-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        /* Responsive */
        @media (max-width: 1200px) { .grid.kpi { grid-template-columns: repeat(3, 1fr); } .grid.charts { grid-template-columns: 1fr; } }
        @media (max-width: 720px) { .layout { grid-template-columns: 1fr; } .sidebar { position: relative; height: auto; } }
    </style>
{% endblock %}

{% block content %}

    <div class="topbar">
        <div class="title">Tổng quan kinh doanh</div>
        <div class="filters">
            <select class="select" id="filter-range">
                <option>Hôm nay</option>
                <option>7 ngày qua</option>
                <option selected>Tháng này</option>
                <option>Tùy chỉnh…</option>
            </select>
            <select class="select" id="filter-branch">
                <option>Tất cả chi nhánh</option>
                <option>Hà Nội</option>
                <option>Hồ Chí Minh</option>
                <option>Đà Nẵng</option>
            </select>
            <button class="button ghost" id="export-sheets">Xuất sang Trang tính</button>
        </div>
    </div>

            <!-- KPI -->
            <div class="grid kpi fade-in stagger-1" id="kpi-grid">
                <div class="card" id="kpi-revenue">
                    <div class="label">Tổng Doanh Thu</div>
                    <div class="value skeleton" style="height: 28px; width: 80%;"></div>
                    <div class="trend skeleton" style="height: 16px; width: 60%;"></div>
                </div>
                <div class="card" id="kpi-gp">
                    <div class="label">Lợi Nhuận Gộp</div>
                    <div class="value skeleton" style="height: 28px; width: 80%;"></div>
                    <div class="trend skeleton" style="height: 16px; width: 50%;"></div>
                </div>
                <div class="card" id="kpi-orders">
                    <div class="label">Số Lượng Đơn Hàng</div>
                    <div class="value skeleton" style="height: 28px; width: 60%;"></div>
                    <div class="trend skeleton" style="height: 16px; width: 50%;"></div>
                </div>
                <div class="card" id="kpi-cr">
                    <div class="label">Tỷ Lệ Chuyển Đổi</div>
                    <div class="value skeleton" style="height: 28px; width: 50%;"></div>
                    <div class="trend skeleton" style="height: 16px; width: 50%;"></div>
                </div>
                <div class="card" id="kpi-aov">
                    <div class="label">AOV (Giá trị TB đơn)</div>
                    <div class="value skeleton" style="height: 28px; width: 70%;"></div>
                    <div class="trend skeleton" style="height: 16px; width: 50%;"></div>
                </div>
                <div class="card" id="kpi-stock">
                    <div class="label">Hàng tồn kho giá trị cao</div>
                    <div class="value skeleton" style="height: 28px; width: 75%;"></div>
                    <div class="tags">
                        <span class="skeleton" style="height: 24px; width: 80px; display: inline-block;"></span>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="section-title">Biểu đồ và xu hướng</div>
            <div class="grid charts fade-in stagger-2">
                <div class="card chart-wrap">
                    <canvas id="chartRevenue"></canvas>
                </div>
                <div class="card chart-wrap">
                    <canvas id="chartProductMix"></canvas>
                </div>
                <div class="card chart-wrap">
                    <canvas id="chartSalesByChannel"></canvas>
                </div>
            </div>

            <!-- Tables -->
            <div class="section-title">Top 5 sản phẩm bán chạy/Lợi nhuận cao</div>
            <div class="card fade-in stagger-3">
                <table id="tbl-top-products">
                    <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th>Doanh thu</th>
                            <th>Lợi nhuận gộp</th>
                            <th>Số lượng</th>
                            <th>Tỷ suất LN</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Áo thun Basic</td><td>₫220.000.000</td><td>₫66.000.000</td><td>1.200</td><td>30%</td></tr>
                        <tr><td>Quần jeans Slim</td><td>₫180.000.000</td><td>₫54.000.000</td><td>760</td><td>30%</td></tr>
                        <tr><td>Giày Runner Pro</td><td>₫150.000.000</td><td>₫60.000.000</td><td>310</td><td>40%</td></tr>
                        <tr><td>Mũ lưỡi trai</td><td>₫90.000.000</td><td>₫22.500.000</td><td>900</td><td>25%</td></tr>
                        <tr><td>Túi đeo chéo</td><td>₫75.000.000</td><td>₫26.250.000</td><td>215</td><td>35%</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="section-title">Đơn hàng cần xử lý/Cảnh báo</div>
            <div class="card">
                <table id="tbl-orders-alert">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Trạng thái</th>
                            <th>Ngày đặt</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>#INV-10421</td><td>Nguyễn Văn A</td><td><span class="tag warn">Chờ xác nhận</span></td><td>2025-09-25</td></tr>
                        <tr><td>#INV-10422</td><td>Trần Thị B</td><td><span class="tag">Đang đóng gói</span></td><td>2025-09-26</td></tr>
                        <tr><td>#INV-10423</td><td>Phạm Văn C</td><td><span class="tag bad">Đã hủy</span></td><td>2025-09-26</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="section-title">Khách hàng thân thiết/Tiềm năng</div>
            <div class="card">
                <table id="tbl-top-customers">
                    <thead>
                        <tr>
                            <th>Khách hàng</th>
                            <th>Lifetime Value</th>
                            <th>Số đơn</th>
                            <th>Lần mua gần nhất</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Đặng Thu D</td><td>₫120.000.000</td><td>34</td><td>2025-09-27</td></tr>
                        <tr><td>Võ Minh E</td><td>₫95.000.000</td><td>28</td><td>2025-09-26</td></tr>
                        <tr><td>Hồ Ngọc F</td><td>₫80.000.000</td><td>22</td><td>2025-09-24</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Alerts & Quick actions & Calendar -->
            <div class="grid" style="grid-template-columns: 2fr 1fr; margin-top: 14px; gap:14px;">
                <div class="card">
                    <div class="section-title">Cảnh báo tồn kho</div>
                    <div class="tags" id="stock-alerts">
                        <span class="tag warn">Áo thun Basic - tồn 8</span>
                        <span class="tag warn">Giày Runner Pro - tồn 5</span>
                        <span class="tag bad">Túi đeo chéo - tồn 2</span>
                    </div>
                    <div class="section-title" style="margin-top:12px;">Cảnh báo khác</div>
                    <div class="tags">
                        <span class="tag bad">Tỷ lệ hủy tăng 12%</span>
                        <span class="tag">Khách hàng VIP mới</span>
                    </div>
                </div>
                <div class="card">
                    <div class="section-title">Tác vụ nhanh</div>
                    <div class="quick-actions">
                        <button class="button brand">Tạo Đơn Hàng Mới</button>
                        <button class="button">Thêm Sản Phẩm Mới</button>
                        <button class="button">Xem Báo Cáo Chi Tiết</button>
                    </div>
                    <div class="section-title" style="margin-top:12px;">Lịch & Sự kiện</div>
                    <div class="tags">
                        <span class="tag">31/10: Kết thúc khuyến mãi</span>
                        <span class="tag">02/11: Nhập hàng kho HN</span>
                        <span class="tag">05/11: Họp kinh doanh</span>
                    </div>
                </div>
    </div>

    <!-- Auto tests + Charts init + API -->
    <div class="test-ribbon" id="test-ribbon">Đang chạy kiểm thử giao diện…</div>
{% endblock %}

{% block scripts %}
<script>
        // Preloader + Data loading
        (function(){
            var preloader = document.getElementById('preloader');
            
            // Fetch dashboard data từ API
            fetch('/api/dashboard-stats')
                .then(function(res){ return res.json(); })
                .then(function(data){
                    // Update KPI cards
                    var fmt = function(n){ return '₫' + Math.round(n).toLocaleString('vi-VN'); };
                    document.querySelector('#kpi-revenue .value').textContent = fmt(data.kpi.total_revenue);
                    document.querySelector('#kpi-revenue .value').classList.remove('skeleton');
                    document.querySelector('#kpi-revenue .trend').innerHTML = '<span style="color:#10b981">▲ +12.4%</span> so với tháng trước';
                    document.querySelector('#kpi-revenue .trend').classList.remove('skeleton');
                    
                    document.querySelector('#kpi-gp .value').textContent = fmt(data.kpi.gross_profit);
                    document.querySelector('#kpi-gp .value').classList.remove('skeleton');
                    document.querySelector('#kpi-gp .trend').innerHTML = '<span style="color:#10b981">▲ +8.1%</span>';
                    document.querySelector('#kpi-gp .trend').classList.remove('skeleton');
                    
                    document.querySelector('#kpi-orders .value').textContent = data.kpi.total_orders;
                    document.querySelector('#kpi-orders .value').classList.remove('skeleton');
                    document.querySelector('#kpi-orders .trend').innerHTML = '<span style="color:#ef4444">▼ -2.3%</span>';
                    document.querySelector('#kpi-orders .trend').classList.remove('skeleton');
                    
                    document.querySelector('#kpi-cr .value').textContent = data.kpi.conversion_rate.toFixed(1) + '%';
                    document.querySelector('#kpi-cr .value').classList.remove('skeleton');
                    document.querySelector('#kpi-cr .trend').innerHTML = '<span style="color:#10b981">▲ +0.4đ</span>';
                    document.querySelector('#kpi-cr .trend').classList.remove('skeleton');
                    
                    document.querySelector('#kpi-aov .value').textContent = fmt(data.kpi.aov);
                    document.querySelector('#kpi-aov .value').classList.remove('skeleton');
                    document.querySelector('#kpi-aov .trend').innerHTML = '<span style="color:#10b981">▲ +3.1%</span>';
                    document.querySelector('#kpi-aov .trend').classList.remove('skeleton');
                    
                    document.querySelector('#kpi-stock .value').textContent = fmt(data.kpi.high_value_stock);
                    document.querySelector('#kpi-stock .value').classList.remove('skeleton');
                    document.querySelector('#kpi-stock .tags').innerHTML = '<span class="tag warn">12 sắp hết</span><span class="tag bad">5 rủi ro</span>';
                    
                    // Update tables
                    var tbl = document.querySelector('#tbl-top-products tbody');
                    tbl.innerHTML = '';
                    data.top_products.forEach(function(p){
                        var row = '<tr><td>' + p.name + '</td><td>' + fmt(p.revenue) + '</td><td>' + fmt(p.profit) + '</td><td>' + p.quantity + '</td><td>' + p.margin + '%</td></tr>';
                        tbl.innerHTML += row;
                    });
                    
                    var tblCust = document.querySelector('#tbl-top-customers tbody');
                    tblCust.innerHTML = '';
                    data.top_customers.forEach(function(c){
                        var row = '<tr><td>' + c.name + '</td><td>' + c.lifetime_value + '</td><td>' + c.orders + '</td><td>' + c.last_purchase + '</td></tr>';
                        tblCust.innerHTML += row;
                    });
                    
                    // Init 3D-style charts with shadow
                    if (window.Chart) {
                        var ctx1 = document.getElementById('chartRevenue');
                        var ctx2 = document.getElementById('chartProductMix');
                        var ctx3 = document.getElementById('chartSalesByChannel');
                        
                        if (ctx1) new Chart(ctx1, {
                            type: 'line',
                            data: { labels: data.charts.revenue.labels, datasets: [
                                { label: 'Doanh thu', data: data.charts.revenue.revenue.map(function(v){ return v/1000000; }), borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,.25)', tension: .35, fill: true, pointRadius: 4, pointHoverRadius: 6, shadowOffsetX: 3, shadowOffsetY: 3, shadowBlur: 10, shadowColor: 'rgba(96,165,250,0.5)' },
                                { label: 'Lợi nhuận', data: data.charts.revenue.profit.map(function(v){ return v/1000000; }), borderColor: '#34d399', backgroundColor: 'rgba(52,211,153,.25)', tension: .35, fill: true, pointRadius: 4, pointHoverRadius: 6 }
                            ] },
                            options: { 
                                responsive: true,
                                plugins: { 
                                    legend: { labels: { color: '#cbd5e1', font: { weight: '600' } } },
                                    tooltip: { backgroundColor: 'rgba(17,24,39,0.95)', titleColor: '#e5e7eb', bodyColor: '#cbd5e1', borderColor: 'rgba(99,102,241,0.3)', borderWidth: 1 }
                                }, 
                                scales: { 
                                    x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }, 
                                    y: { ticks: { color: '#94a3b8', callback: function(v){ return v + 'M'; } }, grid: { color: 'rgba(255,255,255,0.05)' } } 
                                },
                                animation: { duration: 1200, easing: 'easeInOutQuart' }
                            }
                        });
                        
                        if (ctx2) new Chart(ctx2, {
                            type: 'doughnut',
                            data: { labels: data.charts.product_mix.labels, datasets: [{ data: data.charts.product_mix.data, backgroundColor: ['#8b5cf6','#6366f1','#06b6d4','#f59e0b'], borderWidth: 0, hoverOffset: 12 }] },
                            options: { 
                                responsive: true,
                                plugins: { 
                                    legend: { labels: { color: '#cbd5e1', font: { weight: '600' }, padding: 12 } },
                                    tooltip: { backgroundColor: 'rgba(17,24,39,0.95)', titleColor: '#e5e7eb', bodyColor: '#cbd5e1', borderColor: 'rgba(99,102,241,0.3)', borderWidth: 1 }
                                },
                                animation: { animateRotate: true, animateScale: true, duration: 1200 }
                            }
                        });
                        
                        if (ctx3) new Chart(ctx3, {
                            type: 'bar',
                            data: { labels: data.charts.sales_by_channel.labels, datasets: [
                                { label: 'Doanh số', data: data.charts.sales_by_channel.data.map(function(v){ return v/1000000; }), backgroundColor: ['#6366f1','#8b5cf6','#06b6d4','#10b981'], borderRadius: 8, borderSkipped: false, hoverBackgroundColor: ['#818cf8','#a78bfa','#22d3ee','#34d399'] }
                            ] },
                            options: { 
                                responsive: true,
                                plugins: { 
                                    legend: { display: false },
                                    tooltip: { backgroundColor: 'rgba(17,24,39,0.95)', titleColor: '#e5e7eb', bodyColor: '#cbd5e1', borderColor: 'rgba(99,102,241,0.3)', borderWidth: 1 }
                                }, 
                                scales: { 
                                    x: { ticks: { color: '#94a3b8' }, grid: { display: false } }, 
                                    y: { ticks: { color: '#94a3b8', callback: function(v){ return v + 'M'; } }, grid: { color: 'rgba(255,255,255,0.05)' } } 
                                },
                                animation: { duration: 1200, easing: 'easeInOutQuart' }
                            }
                        });
                    }
                    
                    // Smoke tests
                    var results = [];
                    function t(name, condition) { results.push({ name: name, ok: !!condition }); }
                    t('Sidebar tồn tại', document.querySelector('.sidebar'));
                    t('KPI grid có 6 thẻ', document.querySelectorAll('#kpi-grid .card').length === 6);
                    t('Có 3 biểu đồ', document.querySelectorAll('canvas').length >= 3);
                    t('Bảng Top sản phẩm tồn tại', document.getElementById('tbl-top-products'));
                    t('Bảng Đơn hàng cảnh báo tồn tại', document.getElementById('tbl-orders-alert'));
                    t('Bảng Top khách hàng tồn tại', document.getElementById('tbl-top-customers'));
                    t('API data loaded', data.kpi);
                    var allOk = results.every(function(r){ return r.ok; });
                    var ribbon = document.getElementById('test-ribbon');
                    if (allOk) {
                        ribbon.style.background = 'rgba(16,185,129,0.12)';
                        ribbon.style.borderColor = 'rgba(16,185,129,0.45)';
                        ribbon.style.color = '#10b981';
                        ribbon.textContent = 'Kiểm thử: PASSED (' + results.length + ' checks | API: OK)';
                    } else {
                        ribbon.style.background = 'rgba(239,68,68,0.12)';
                        ribbon.style.borderColor = 'rgba(239,68,68,0.45)';
                        ribbon.style.color = '#ef4444';
                        var failed = results.filter(function(r){ return !r.ok; }).map(function(r){ return r.name; }).join(', ');
                        ribbon.textContent = 'Kiểm thử: FAILED -> ' + failed;
                        console.error('UI tests failed:', results);
                    }
                    
                    // Hide preloader
                    setTimeout(function(){
                        preloader.classList.add('hidden');
                    }, 300);
                })
                .catch(function(err){
                    console.error('API error:', err);
                    document.getElementById('test-ribbon').textContent = 'API Error: ' + err.message;
                    document.getElementById('test-ribbon').style.color = '#ef4444';
                    preloader.classList.add('hidden');
                });
        })();
</script>
{% endblock %}
